upstream tripmaster_upstream {
  server tripmaster:3000;
}

# ---------- MAIN SERVER CONFIG ----------
server {
    listen 80;
    server_name _;
    server_tokens off;

    # Enable debug logging
    error_log /var/log/nginx/error.log debug;

    # WebSocket support
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;

    gzip on;
    gzip_proxied any;
    gzip_comp_level 4;
    gzip_min_length 256;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    location /assets {
        proxy_pass http://tripmaster_upstream;
        proxy_cache my_cache;
        proxy_cache_valid 200 302 7d;
        proxy_cache_valid 404 1m;
        
        # Cache configuration
        # proxy_cache_key "$scheme$request_method$host$request_uri";
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 5s;
        
        # Override any cache-control headers from upstream
        proxy_ignore_headers Cache-Control;
        proxy_ignore_headers Set-Cookie;
        proxy_ignore_headers Expires;
        
        # Set our own cache headers
        expires 30d;
        add_header Cache-Control "public, immutable, max-age=2592000, stale-while-revalidate=86400";
        
        # Debug headers
        add_header X-Cache-Status $upstream_cache_status always;
    }

    location / {
        proxy_pass http://tripmaster_upstream;
        proxy_cache my_cache;
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404 1m;
        
        # Rate limiting
        limit_req zone=one burst=20 nodelay;
        
        # Cache control for HTML pages
        add_header Cache-Control "public, max-age=0, must-revalidate";
        
        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.syncfusion.com; style-src 'self' https://fonts.googleapis.com https://cdn.syncfusion.com; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data: https: https://*.googleusercontent.com https://images.unsplash.com; connect-src 'self' https://*.cloud.appwrite.io; frame-ancestors 'self';" always;
        add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
        
        # Cache debugging headers
        add_header X-Cache-Status $upstream_cache_status always;
        add_header X-Cache-Info "$scheme://$host$request_uri" always;
    }
}
